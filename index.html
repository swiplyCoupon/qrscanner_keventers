<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Swiply Coupon Scanner</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAe7U1v7pszSh2NjV82JND9DNNnGxs_PCQ",
      authDomain: "mingler1-ae.firebaseapp.com",
      projectId: "mingler1-ae",
      storageBucket: "mingler1-ae.appspot.com",
      messagingSenderId: "745303082451",
      appId: "1:745303082451:web:d4379cf92a334827741b26",
      measurementId: "G-ER61EHLDCN"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentCouponId = null;
    let scanner = null; // store scanner instance
    let countdownInterval = null;

    async function onScanSuccess(decodedText) {
      const couponId = decodedText.trim();
      currentCouponId = couponId;

      try {
        const ref = doc(db, "coupons", couponId);
        const snap = await getDoc(ref);

        if (!snap.exists()) {
          showMessage("‚ùå Coupon not found", "error");
          document.getElementById("redeemBtn").style.display = "none";
          return;
        }

        const data = snap.data();
        if (data.redeemed) {
          showMessage("‚ö†Ô∏è Coupon already redeemed", "warning");
          document.getElementById("redeemBtn").style.display = "none";
          return;
        }

        // ‚úÖ Show company name if available
        const companyDisplay = data.companyName ? ` (${data.companyName})` : "";
        showMessage(`‚úÖ Coupon valid${companyDisplay}`, "success");
        document.getElementById("redeemBtn").style.display = "inline-block";

      } catch (err) {
        showMessage("‚ùå Error: " + err.message, "error");
        document.getElementById("redeemBtn").style.display = "none";
      }
    }

    async function redeemCoupon() {
      if (!currentCouponId) {
        showMessage("‚ö†Ô∏è No coupon scanned", "warning");
        return;
      }

      try {
        const ref = doc(db, "coupons", currentCouponId);
        await updateDoc(ref, {
          redeemed: true,
          redeemedAt: serverTimestamp()
        });

        showMessage("üéâ Coupon redeemed successfully! ‚è≥ Scanning resumes in 4s", "success");
        document.getElementById("redeemBtn").style.display = "none";
        currentCouponId = null;

        // üõë Stop scanner during cooldown
        if (scanner) {
          scanner.stop().catch(e => console.error("Scanner stop error:", e));
        }

        // Countdown before restarting scanner
        let remaining = 4;
        countdownInterval = setInterval(() => {
          remaining--;
          if (remaining > 0) {
            document.getElementById("message").innerText =
              `üéâ Coupon redeemed successfully! ‚è≥ Scanning resumes in ${remaining}s`;
          } else {
            clearInterval(countdownInterval);
            showMessage("‚úÖ Ready to scan next coupon", "success");

            // üîÑ Restart scanner
            scanner.start(
              { facingMode: { exact: "environment" } },
              { fps: 10, qrbox: 250 },
              onScanSuccess
            ).catch(err => {
              showMessage("‚ùå Camera error: " + err, "error");
            });
          }
        }, 1000);

      } catch (err) {
        showMessage("‚ùå Error: " + err.message, "error");
      }
    }

    function showMessage(text, type) {
      const messageBox = document.getElementById("message");
      messageBox.innerText = text;
      messageBox.className = type;
      messageBox.style.display = "block";
    }

    window.onload = () => {
      scanner = new Html5Qrcode("reader");
      scanner.start(
        { facingMode: { exact: "environment" } },
        { fps: 10, qrbox: 250 },
        onScanSuccess
      ).catch(err => {
        showMessage("‚ùå Camera error: " + err, "error");
      });

      document.getElementById("redeemBtn").addEventListener("click", redeemCoupon);
    };
  </script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background-color: #121212;
      margin: 0;
      padding: 0;
      color: white;
    }
    h1 {
      margin-top: 20px;
      font-size: 24px;
      color: #FFD700;
    }
    p {
      margin-bottom: 20px;
      font-size: 14px;
      color: #ccc;
    }
    #reader {
      width: 90%;
      max-width: 400px;
      margin: auto;
      border: 2px solid #FFD700;
      border-radius: 10px;
      overflow: hidden;
    }
    #message {
      display: none;
      margin-top: 20px;
      padding: 10px;
      border-radius: 6px;
      font-weight: bold;
    }
    #message.success {
      background-color: #4CAF50;
      color: white;
    }
    #message.error {
      background-color: #f44336;
      color: white;
    }
    #message.warning {
      background-color: #ff9800;
      color: black;
    }
    #redeemBtn {
      display: none;
      margin-top: 20px;
      padding: 10px 20px;
      background-color: #FFD700;
      color: black;
      font-weight: bold;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    #redeemBtn:hover {
      background-color: #e6c200;
    }
  </style>
</head>
<body>
  <h1>Swiply Coupon Scanner</h1>
  <p>Point the camera at the customer's QR code to verify. Click redeem to confirm.</p>
  <div id="reader"></div>
  <div id="message"></div>
  <button id="redeemBtn">‚úÖ Redeem Now</button>
</body>
</html>
